<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–æ–∏ –±—Ä–æ–Ω–∏</title>
  <link rel="stylesheet" href="../assets/css/style_gym.css" />
  <link rel="stylesheet" href="../assets/css/style_profile.css">
  
</head>
<body>
  <header>
    <div class="container">
      <h1>1Fit</h1>
      <nav>
        <ul>
          <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
          <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
          <li><a href="profile.html">–ú–æ–∏ –±—Ä–æ–Ω–∏</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="container">
    <h2>–ú–æ–∏ –±—Ä–æ–Ω–∏</h2>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ª—É, –¥–Ω—é –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏..." style="margin-bottom: 20px; padding: 8px; width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px;">
    <ul id="bookingList" class="booking-list"></ul>
    <button class="btn" id="clearBookingsBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
  </section>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h3>–ò–∑–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</h3>
      <label>–ù–æ–≤—ã–π –¥–µ–Ω—å:</label>
      <select id="editDaySelect" onchange="updateTimeOptions()" required>
        <option value="–ü–Ω">–ü–Ω</option>
        <option value="–í—Ç">–í—Ç</option>
        <option value="–°—Ä">–°—Ä</option>
        <option value="–ß—Ç">–ß—Ç</option>
        <option value="–ü—Ç">–ü—Ç</option>
        <option value="–°–±">–°–±</option>
      </select>
      <label>–ù–æ–≤–æ–µ –≤—Ä–µ–º—è:</label>
      <select id="editTimeSelect" required></select>
      <button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <div class="filters">
    <label>–§–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—é:</label>
    <select id="dayFilter">
      <option value="">–í—Å–µ</option>
      <option value="–ü–Ω">–ü–Ω</option>
      <option value="–í—Ç">–í—Ç</option>
      <option value="–°—Ä">–°—Ä</option>
      <option value="–ß—Ç">–ß—Ç</option>
      <option value="–ü—Ç">–ü—Ç</option>
      <option value="–°–±">–°–±</option>
    </select>
  
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
    <select id="categoryFilter">
      <option value="">–í—Å–µ</option>
      <option value="–§–∏—Ç–Ω–µ—Å">–§–∏—Ç–Ω–µ—Å</option>
      <option value="–¢—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π –∑–∞–ª">–¢—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π –∑–∞–ª</option>
      <option value="–ô–æ–≥–∞">–ô–æ–≥–∞</option>
      <option value="–ü–ª–∞–≤–∞–Ω–∏–µ">–ü–ª–∞–≤–∞–Ω–∏–µ</option>
    </select>
  </div>
  
  

  <footer>
    <div class="container">
      <p>&copy; 2025 1Fit Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
  </footer>

  <script>
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    const allBookings = JSON.parse(localStorage.getItem("userBookings")) || {};
    const scheduleSlots = JSON.parse(localStorage.getItem("scheduleSlots")) || {
    };

    const bookingList = document.getElementById("bookingList");
    const clearBtn = document.getElementById("clearBookingsBtn");

    let currentEditIndex = null;

    function saveAll() {
      localStorage.setItem("userBookings", JSON.stringify(allBookings));
      localStorage.setItem("scheduleSlots", JSON.stringify(scheduleSlots));
    }

    function renderBookings(searchText = "") {
      bookingList.innerHTML = "";
      const userBookings = allBookings[user?.login] || [];
    
      const selectedDay = document.getElementById("dayFilter").value;
      const selectedCategory = document.getElementById("categoryFilter").value;
    
      const filtered = userBookings.filter(b => {
        const matchesSearch = `${b.gymName} ${b.day} ${b.time}`.toLowerCase().includes(searchText.toLowerCase());
        const matchesDay = selectedDay === "" || b.day === selectedDay;
        const matchesCategory = selectedCategory === "" || b.category === selectedCategory;
        return matchesSearch && matchesDay && matchesCategory;
      });
    
      if (filtered.length === 0) {
        bookingList.innerHTML = "<li>‚Ä¢ –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</li>";
        return;
      }
    
      filtered.forEach((b, i) => {
        const isFav = (JSON.parse(localStorage.getItem("favorites")) || []).includes(b.gymName);
        const star = isFav ? "‚≠ê" : "‚òÜ";
        const li = document.createElement("li");
        li.innerHTML = `
          ${star} <strong>${b.gymName}</strong> ‚Äî üìÖ ${b.day}, üïí ${b.time}
          <button class="edit-btn" onclick="openEditModal(${i})">‚úè</button>
          <button class="delete-btn" onclick="deleteBooking(${i})">üóë</button>
          <button onclick="toggleFavorite('${b.gymName}')">‚ù§Ô∏è</button>
        `;
        bookingList.appendChild(li);
      });
    }
    
    

    function deleteBooking(index) {
      const userBookings = allBookings[user.login];
      const removed = userBookings.splice(index, 1)[0];

      if (removed && scheduleSlots[removed.day]) {
        const slot = scheduleSlots[removed.day].find(s => s.time === removed.time);
        if (slot) slot.spots++;
      }

      saveAll();
      renderBookings();
    }

    clearBtn.onclick = () => {
      const bookings = allBookings[user.login] || [];
      bookings.forEach(b => {
        const slot = scheduleSlots[b.day]?.find(s => s.time === b.time);
        if (slot) slot.spots++;
      });

      delete allBookings[user.login];
      saveAll();
      renderBookings();
      alert("‚úÖ –í—Å–µ –±—Ä–æ–Ω–∏ —É–¥–∞–ª–µ–Ω—ã!");
    };

    function openEditModal(index) {
      currentEditIndex = index;
      const booking = allBookings[user.login][index];
      document.getElementById("editDaySelect").value = booking.day;
      updateTimeOptions(booking.day); // –æ–±–Ω–æ–≤–∏–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
      document.getElementById("editTimeSelect").value = booking.time;
      document.getElementById("editModal").style.display = "block";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }

    function updateTimeOptions(day) {
      const timeSelect = document.getElementById("editTimeSelect");
      timeSelect.innerHTML = "";
    
      if (scheduleSlots[day]) {
        scheduleSlots[day].forEach(slot => {
          if (slot.spots > 0) {
            const opt = document.createElement("option");
            opt.value = slot.time;
            opt.textContent = `${slot.time} (${slot.spots} –º–µ—Å—Ç)`;
            timeSelect.appendChild(opt);
          }
        });
      }
    }

    function saveEdit() {
      const newDay = document.getElementById("editDaySelect").value;
      const newTime = document.getElementById("editTimeSelect").value;
      const userBookings = allBookings[user.login];
      const booking = userBookings[currentEditIndex];

      if (!newDay || !newTime) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è.");
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–∞—è –±—Ä–æ–Ω—å
      const exists = userBookings.some((b, i) =>
        i !== currentEditIndex && b.day === newDay && b.time === newTime
      );
      if (exists) {
        alert("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±—Ä–æ–Ω—å –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è.");
        return;
      }

      // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ—Ç
      const oldSlot = scheduleSlots[booking.day]?.find(s => s.time === booking.time);
      if (oldSlot) oldSlot.spots++;

      // –ó–∞–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ—Ç
      const newSlot = scheduleSlots[newDay]?.find(s => s.time === newTime);
      if (newSlot && newSlot.spots > 0) {
        newSlot.spots--;
      } else {
        alert("–ù–µ—Ç –º–µ—Å—Ç –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è.");
        return;
      }

      booking.day = newDay;
      booking.time = newTime;

      saveAll();
      closeEditModal();
      renderBookings();
    }

    function toggleFavorite(gymName) {
      let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
    
      if (favorites.includes(gymName)) {
        favorites = favorites.filter(g => g !== gymName);
      } else {
        favorites.push(gymName);
      }
    
      localStorage.setItem("favorites", JSON.stringify(favorites));
      renderBookings(document.getElementById("searchInput").value);
    }
    

    document.getElementById("searchInput").addEventListener("input", function () {
      renderBookings(this.value);
    });
    document.getElementById("dayFilter").addEventListener("change", function () {
      renderBookings(document.getElementById("searchInput").value);
    });
    
    document.getElementById("categoryFilter").addEventListener("change", function () {
      renderBookings(document.getElementById("searchInput").value);
    });

    document.getElementById("editDaySelect").addEventListener("change", function () {
      const selectedDay = this.value;
      updateTimeOptions(selectedDay);
    });

    renderBookings();
    window.deleteBooking = deleteBooking;
    window.openEditModal = openEditModal;
    window.closeEditModal = closeEditModal;
    window.saveEdit = saveEdit;
  </script>
</body>
</html>
